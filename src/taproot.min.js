/*! For license information please see taproot.min.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.taproot=e():t.taproot=e()}(this,(()=>(()=>{"use strict";var t={d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,i,o,s,a=[],c=!0,u=!1;try{if(o=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=o.call(r)).done)&&(a.push(n.value),a.length!==e);c=!0);}catch(t){u=!0,i=t}finally{try{if(!c&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(u)throw i}}return a}}(t,e)||function(t,e){if(t){if("string"==typeof t)return n(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function o(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,s(n.key),n)}}function s(t){var e=function(t,e){if("object"!=i(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==i(e)?e:e+""}t.r(e),t.d(e,{Taproot:()=>Gt});var a=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),e instanceof t)this.data=e.data,this.shape=e.shape,this.dtype=e.dtype;else if(t.isTypedArray(e)){var o=t.getDataTypeFromTypedArray(e);null!==n&&o!==n?(this.data=new(t.getArrayConstructorFromDataType(n))(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)),this.dtype=n):(this.data=e,this.dtype=o),null===r&&(r=[e.length]),this.shape=r}else if(null!==n)this.data=new(t.getArrayConstructorFromDataType(n))(e),null===r&&(r=[e.length]),this.shape=r,this.dtype=n;else{if(!Array.isArray(e))throw new Error("Invalid data type ".concat(i(e)," (").concat(e.constructor.name,")"));this.data=new Int32Array(e),this.shape=[e.length],this.dtype="int32"}}return e=t,n=[{key:"get",value:function(){var t=Array.from(arguments);if(t.length!==this.shape.length)throw new Error("Incorrect number of indexes");for(var e=0,r=0;r<t.length;r++)e+=t[r]*this.strides[r];return this.data[e]}},{key:"set",value:function(){var t=Array.from(arguments),e=t.pop();if(t.length!==this.shape.length)throw new Error("Incorrect number of indexes");for(var r=0,n=0;n<t.length;n++)r+=t[n]*this.strides[n];this.data[r]=e}},{key:"packed",get:function(){return{type:"ndarray",shape:this.shape,dtype:this.dtype,data:this.data}}},{key:"imageData",get:function(){if(3!==this.shape.length)throw new Error("Can only get ImageData from 3D array (height, width, channels)");var t=r(this.shape,3),e=t[0],n=t[1];if(3===t[2]){for(var i=new Uint8ClampedArray(n*e*4),o=0;o<n*e;o++)i[4*o]=this.data[3*o],i[4*o+1]=this.data[3*o+1],i[4*o+2]=this.data[3*o+2],i[4*o+3]=255;return new ImageData(i,n,e)}return new ImageData(new Uint8ClampedArray(this.data.buffer.slice(this.data.byteOffset,this.data.byteOffset+this.data.byteLength)),n,e)}},{key:"toString",value:function(){return"NDArray(".concat(this.data,", ").concat(this.shape,", ").concat(this.dtype,")")}}],s=[{key:"getDataTypeFromTypedArray",value:function(e){if(t.isTypedArray(e))return e.constructor.name.replace("Array","").toLowerCase();throw new Error("Not a typed array: ".concat(e.constructor.name))}},{key:"getArrayConstructorFromDataType",value:function(t){switch(t){case"float32":return Float32Array;case"float64":return Float64Array;case"int8":return Int8Array;case"int16":return Int16Array;case"int32":return Int32Array;case"uint8":return Uint8Array;case"uint16":return Uint16Array;case"uint32":return Uint32Array;default:throw new Error("Unknown data type: ".concat(t))}}},{key:"isTypedArray",value:function(t){return t instanceof Float32Array||t instanceof Float64Array||t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array}}],n&&o(e.prototype,n),s&&o(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,s}();const c=new TextEncoder;function u(t,e,r){t.length>50?function(t,e,r){c.encodeInto(t,e.subarray(r))}(t,e,r):function(t,e,r){const n=t.length;let i=r,o=0;for(;o<n;){let r=t.charCodeAt(o++);if(4294967168&r){if(4294965248&r){if(r>=55296&&r<=56319&&o<n){const e=t.charCodeAt(o);56320==(64512&e)&&(++o,r=((1023&r)<<10)+(1023&e)+65536)}4294901760&r?(e[i++]=r>>18&7|240,e[i++]=r>>12&63|128,e[i++]=r>>6&63|128):(e[i++]=r>>12&15|224,e[i++]=r>>6&63|128)}else e[i++]=r>>6&31|192;e[i++]=63&r|128}else e[i++]=r}}(t,e,r)}function h(t,e,r){let n=e;const i=n+r,o=[];let s="";for(;n<i;){const e=t[n++];if(128&e)if(192==(224&e)){const r=63&t[n++];o.push((31&e)<<6|r)}else if(224==(240&e)){const r=63&t[n++],i=63&t[n++];o.push((31&e)<<12|r<<6|i)}else if(240==(248&e)){let r=(7&e)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++];r>65535&&(r-=65536,o.push(r>>>10&1023|55296),r=56320|1023&r),o.push(r)}else o.push(e);else o.push(e);o.length>=4096&&(s+=String.fromCharCode(...o),o.length=0)}return o.length>0&&(s+=String.fromCharCode(...o)),s}const f=new TextDecoder;function l(t,e,r){return r>200?function(t,e,r){const n=t.subarray(e,e+r);return f.decode(n)}(t,e,r):h(t,e,r)}class d{constructor(t,e){this.type=t,this.data=e}}class y extends Error{constructor(t){super(t);const e=Object.create(y.prototype);Object.setPrototypeOf(this,e),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:y.name})}}const p=4294967295;function g(t,e,r){const n=Math.floor(r/4294967296),i=r;t.setUint32(e,n),t.setUint32(e+4,i)}function v(t,e){return 4294967296*t.getInt32(e)+t.getUint32(e+4)}const m={type:-1,encode:function(t){if(t instanceof Date){return function({sec:t,nsec:e}){if(t>=0&&e>=0&&t<=17179869183){if(0===e&&t<=4294967295){const e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t),e}{const r=t/4294967296,n=4294967295&t,i=new Uint8Array(8),o=new DataView(i.buffer);return o.setUint32(0,e<<2|3&r),o.setUint32(4,n),i}}{const r=new Uint8Array(12),n=new DataView(r.buffer);return n.setUint32(0,e),g(n,4,t),r}}(function(t){const e=t.getTime(),r=Math.floor(e/1e3),n=1e6*(e-1e3*r),i=Math.floor(n/1e9);return{sec:r+i,nsec:n-1e9*i}}(t))}return null},decode:function(t){const e=function(t){const e=new DataView(t.buffer,t.byteOffset,t.byteLength);switch(t.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{const t=e.getUint32(0);return{sec:4294967296*(3&t)+e.getUint32(4),nsec:t>>>2}}case 12:return{sec:v(e,4),nsec:e.getUint32(0)};default:throw new y(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${t.length}`)}}(t);return new Date(1e3*e.sec+e.nsec/1e6)}};class w{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(m)}register({type:t,encode:e,decode:r}){if(t>=0)this.encoders[t]=e,this.decoders[t]=r;else{const n=-1-t;this.builtInEncoders[n]=e,this.builtInDecoders[n]=r}}tryToEncode(t,e){for(let r=0;r<this.builtInEncoders.length;r++){const n=this.builtInEncoders[r];if(null!=n){const i=n(t,e);if(null!=i){return new d(-1-r,i)}}}for(let r=0;r<this.encoders.length;r++){const n=this.encoders[r];if(null!=n){const i=n(t,e);if(null!=i){return new d(r,i)}}}return t instanceof d?t:null}decode(t,e,r){const n=e<0?this.builtInDecoders[-1-e]:this.decoders[e];return n?n(t,e,r):new d(e,t)}}function b(t){return t instanceof Uint8Array?t:ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):function(t){return t instanceof ArrayBuffer||"undefined"!=typeof SharedArrayBuffer&&t instanceof SharedArrayBuffer}(t)?new Uint8Array(t):Uint8Array.from(t)}w.defaultCodec=new w;class k{constructor(t){this.entered=!1,this.extensionCodec=t?.extensionCodec??w.defaultCodec,this.context=t?.context,this.useBigInt64=t?.useBigInt64??!1,this.maxDepth=t?.maxDepth??100,this.initialBufferSize=t?.initialBufferSize??2048,this.sortKeys=t?.sortKeys??!1,this.forceFloat32=t?.forceFloat32??!1,this.ignoreUndefined=t?.ignoreUndefined??!1,this.forceIntegerToFloat=t?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new k({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(t){if(this.entered){return this.clone().encodeSharedRef(t)}try{return this.entered=!0,this.reinitializeState(),this.doEncode(t,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(t){if(this.entered){return this.clone().encode(t)}try{return this.entered=!0,this.reinitializeState(),this.doEncode(t,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(t,e){if(e>this.maxDepth)throw new Error(`Too deep objects in depth ${e}`);null==t?this.encodeNil():"boolean"==typeof t?this.encodeBoolean(t):"number"==typeof t?this.forceIntegerToFloat?this.encodeNumberAsFloat(t):this.encodeNumber(t):"string"==typeof t?this.encodeString(t):this.useBigInt64&&"bigint"==typeof t?this.encodeBigInt64(t):this.encodeObject(t,e)}ensureBufferSizeToWrite(t){const e=this.pos+t;this.view.byteLength<e&&this.resizeBuffer(2*e)}resizeBuffer(t){const e=new ArrayBuffer(t),r=new Uint8Array(e),n=new DataView(e);r.set(this.bytes),this.view=n,this.bytes=r}encodeNil(){this.writeU8(192)}encodeBoolean(t){!1===t?this.writeU8(194):this.writeU8(195)}encodeNumber(t){!this.forceIntegerToFloat&&Number.isSafeInteger(t)?t>=0?t<128?this.writeU8(t):t<256?(this.writeU8(204),this.writeU8(t)):t<65536?(this.writeU8(205),this.writeU16(t)):t<4294967296?(this.writeU8(206),this.writeU32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(207),this.writeU64(t)):t>=-32?this.writeU8(224|t+32):t>=-128?(this.writeU8(208),this.writeI8(t)):t>=-32768?(this.writeU8(209),this.writeI16(t)):t>=-2147483648?(this.writeU8(210),this.writeI32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(211),this.writeI64(t)):this.encodeNumberAsFloat(t)}encodeNumberAsFloat(t){this.forceFloat32?(this.writeU8(202),this.writeF32(t)):(this.writeU8(203),this.writeF64(t))}encodeBigInt64(t){t>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(t)):(this.writeU8(211),this.writeBigInt64(t))}writeStringHeader(t){if(t<32)this.writeU8(160+t);else if(t<256)this.writeU8(217),this.writeU8(t);else if(t<65536)this.writeU8(218),this.writeU16(t);else{if(!(t<4294967296))throw new Error(`Too long string: ${t} bytes in UTF-8`);this.writeU8(219),this.writeU32(t)}}encodeString(t){const e=function(t){const e=t.length;let r=0,n=0;for(;n<e;){let i=t.charCodeAt(n++);if(4294967168&i)if(4294965248&i){if(i>=55296&&i<=56319&&n<e){const e=t.charCodeAt(n);56320==(64512&e)&&(++n,i=((1023&i)<<10)+(1023&e)+65536)}r+=4294901760&i?4:3}else r+=2;else r++}return r}(t);this.ensureBufferSizeToWrite(5+e),this.writeStringHeader(e),u(t,this.bytes,this.pos),this.pos+=e}encodeObject(t,e){const r=this.extensionCodec.tryToEncode(t,this.context);if(null!=r)this.encodeExtension(r);else if(Array.isArray(t))this.encodeArray(t,e);else if(ArrayBuffer.isView(t))this.encodeBinary(t);else{if("object"!=typeof t)throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(t)}`);this.encodeMap(t,e)}}encodeBinary(t){const e=t.byteLength;if(e<256)this.writeU8(196),this.writeU8(e);else if(e<65536)this.writeU8(197),this.writeU16(e);else{if(!(e<4294967296))throw new Error(`Too large binary: ${e}`);this.writeU8(198),this.writeU32(e)}const r=b(t);this.writeU8a(r)}encodeArray(t,e){const r=t.length;if(r<16)this.writeU8(144+r);else if(r<65536)this.writeU8(220),this.writeU16(r);else{if(!(r<4294967296))throw new Error(`Too large array: ${r}`);this.writeU8(221),this.writeU32(r)}for(const r of t)this.doEncode(r,e+1)}countWithoutUndefined(t,e){let r=0;for(const n of e)void 0!==t[n]&&r++;return r}encodeMap(t,e){const r=Object.keys(t);this.sortKeys&&r.sort();const n=this.ignoreUndefined?this.countWithoutUndefined(t,r):r.length;if(n<16)this.writeU8(128+n);else if(n<65536)this.writeU8(222),this.writeU16(n);else{if(!(n<4294967296))throw new Error(`Too large map object: ${n}`);this.writeU8(223),this.writeU32(n)}for(const n of r){const r=t[n];this.ignoreUndefined&&void 0===r||(this.encodeString(n),this.doEncode(r,e+1))}}encodeExtension(t){if("function"==typeof t.data){const e=t.data(this.pos+6),r=e.length;if(r>=4294967296)throw new Error(`Too large extension object: ${r}`);return this.writeU8(201),this.writeU32(r),this.writeI8(t.type),void this.writeU8a(e)}const e=t.data.length;if(1===e)this.writeU8(212);else if(2===e)this.writeU8(213);else if(4===e)this.writeU8(214);else if(8===e)this.writeU8(215);else if(16===e)this.writeU8(216);else if(e<256)this.writeU8(199),this.writeU8(e);else if(e<65536)this.writeU8(200),this.writeU16(e);else{if(!(e<4294967296))throw new Error(`Too large extension object: ${e}`);this.writeU8(201),this.writeU32(e)}this.writeI8(t.type),this.writeU8a(t.data)}writeU8(t){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,t),this.pos++}writeU8a(t){const e=t.length;this.ensureBufferSizeToWrite(e),this.bytes.set(t,this.pos),this.pos+=e}writeI8(t){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,t),this.pos++}writeU16(t){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,t),this.pos+=2}writeI16(t){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,t),this.pos+=2}writeU32(t){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,t),this.pos+=4}writeI32(t){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,t),this.pos+=4}writeF32(t){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,t),this.pos+=4}writeF64(t){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,t),this.pos+=8}writeU64(t){this.ensureBufferSizeToWrite(8),function(t,e,r){const n=r/4294967296,i=r;t.setUint32(e,n),t.setUint32(e+4,i)}(this.view,this.pos,t),this.pos+=8}writeI64(t){this.ensureBufferSizeToWrite(8),g(this.view,this.pos,t),this.pos+=8}writeBigUint64(t){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,t),this.pos+=8}writeBigInt64(t){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,t),this.pos+=8}}function x(t){return`${t<0?"-":""}0x${Math.abs(t).toString(16).padStart(2,"0")}`}const S="array",U="map_key",E="map_value",I=t=>{if("string"==typeof t||"number"==typeof t)return t;throw new y("The type of key must be string or number but "+typeof t)};class A{constructor(){this.stack=[],this.stackHeadPosition=-1}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(t){const e=this.getUninitializedStateFromPool();e.type=S,e.position=0,e.size=t,e.array=new Array(t)}pushMapState(t){const e=this.getUninitializedStateFromPool();e.type=U,e.readCount=0,e.size=t,e.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){const t={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(t)}return this.stack[this.stackHeadPosition]}release(t){if(this.stack[this.stackHeadPosition]!==t)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(t.type===S){const e=t;e.size=0,e.array=void 0,e.position=0,e.type=void 0}if(t.type===U||t.type===E){const e=t;e.size=0,e.map=void 0,e.readCount=0,e.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}}const L=new DataView(new ArrayBuffer(0)),O=new Uint8Array(L.buffer);try{L.getInt8(0)}catch(t){if(!(t instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}const B=new RangeError("Insufficient data"),P=new class{constructor(t=16,e=16){this.hit=0,this.miss=0,this.maxKeyLength=t,this.maxLengthPerKey=e,this.caches=[];for(let t=0;t<this.maxKeyLength;t++)this.caches.push([])}canBeCached(t){return t>0&&t<=this.maxKeyLength}find(t,e,r){const n=this.caches[r-1];t:for(const i of n){const n=i.bytes;for(let i=0;i<r;i++)if(n[i]!==t[e+i])continue t;return i.str}return null}store(t,e){const r=this.caches[t.length-1],n={bytes:t,str:e};r.length>=this.maxLengthPerKey?r[Math.random()*r.length|0]=n:r.push(n)}decode(t,e,r){const n=this.find(t,e,r);if(null!=n)return this.hit++,n;this.miss++;const i=h(t,e,r),o=Uint8Array.prototype.slice.call(t,e,e+r);return this.store(o,i),i}};class j{constructor(t){this.totalPos=0,this.pos=0,this.view=L,this.bytes=O,this.headByte=-1,this.stack=new A,this.entered=!1,this.extensionCodec=t?.extensionCodec??w.defaultCodec,this.context=t?.context,this.useBigInt64=t?.useBigInt64??!1,this.rawStrings=t?.rawStrings??!1,this.maxStrLength=t?.maxStrLength??p,this.maxBinLength=t?.maxBinLength??p,this.maxArrayLength=t?.maxArrayLength??p,this.maxMapLength=t?.maxMapLength??p,this.maxExtLength=t?.maxExtLength??p,this.keyDecoder=void 0!==t?.keyDecoder?t.keyDecoder:P,this.mapKeyConverter=t?.mapKeyConverter??I}clone(){return new j({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=-1,this.stack.reset()}setBuffer(t){const e=b(t);this.bytes=e,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.pos=0}appendBuffer(t){if(-1!==this.headByte||this.hasRemaining(1)){const e=this.bytes.subarray(this.pos),r=b(t),n=new Uint8Array(e.length+r.length);n.set(e),n.set(r,e.length),this.setBuffer(n)}else this.setBuffer(t)}hasRemaining(t){return this.view.byteLength-this.pos>=t}createExtraByteError(t){const{view:e,pos:r}=this;return new RangeError(`Extra ${e.byteLength-r} of ${e.byteLength} byte(s) found at buffer[${t}]`)}decode(t){if(this.entered){return this.clone().decode(t)}try{this.entered=!0,this.reinitializeState(),this.setBuffer(t);const e=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return e}finally{this.entered=!1}}*decodeMulti(t){if(this.entered){const e=this.clone();yield*e.decodeMulti(t)}else try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(t);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(t){if(this.entered){return this.clone().decodeAsync(t)}try{this.entered=!0;let e,r=!1;for await(const n of t){if(r)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(n);try{e=this.doDecodeSync(),r=!0}catch(t){if(!(t instanceof RangeError))throw t}this.totalPos+=this.pos}if(r){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return e}const{headByte:n,pos:i,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${x(n)} at ${o} (${i} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(t){return this.decodeMultiAsync(t,!0)}decodeStream(t){return this.decodeMultiAsync(t,!1)}async*decodeMultiAsync(t,e){if(this.entered){const r=this.clone();yield*r.decodeMultiAsync(t,e)}else try{this.entered=!0;let r=e,n=-1;for await(const i of t){if(e&&0===n)throw this.createExtraByteError(this.totalPos);this.appendBuffer(i),r&&(n=this.readArraySize(),r=!1,this.complete());try{for(;yield this.doDecodeSync(),0!=--n;);}catch(t){if(!(t instanceof RangeError))throw t}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){t:for(;;){const t=this.readHeadByte();let e;if(t>=224)e=t-256;else if(t<192)if(t<128)e=t;else if(t<144){const r=t-128;if(0!==r){this.pushMapState(r),this.complete();continue t}e={}}else if(t<160){const r=t-144;if(0!==r){this.pushArrayState(r),this.complete();continue t}e=[]}else{const r=t-160;e=this.decodeString(r,0)}else if(192===t)e=null;else if(194===t)e=!1;else if(195===t)e=!0;else if(202===t)e=this.readF32();else if(203===t)e=this.readF64();else if(204===t)e=this.readU8();else if(205===t)e=this.readU16();else if(206===t)e=this.readU32();else if(207===t)e=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===t)e=this.readI8();else if(209===t)e=this.readI16();else if(210===t)e=this.readI32();else if(211===t)e=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===t){const t=this.lookU8();e=this.decodeString(t,1)}else if(218===t){const t=this.lookU16();e=this.decodeString(t,2)}else if(219===t){const t=this.lookU32();e=this.decodeString(t,4)}else if(220===t){const t=this.readU16();if(0!==t){this.pushArrayState(t),this.complete();continue t}e=[]}else if(221===t){const t=this.readU32();if(0!==t){this.pushArrayState(t),this.complete();continue t}e=[]}else if(222===t){const t=this.readU16();if(0!==t){this.pushMapState(t),this.complete();continue t}e={}}else if(223===t){const t=this.readU32();if(0!==t){this.pushMapState(t),this.complete();continue t}e={}}else if(196===t){const t=this.lookU8();e=this.decodeBinary(t,1)}else if(197===t){const t=this.lookU16();e=this.decodeBinary(t,2)}else if(198===t){const t=this.lookU32();e=this.decodeBinary(t,4)}else if(212===t)e=this.decodeExtension(1,0);else if(213===t)e=this.decodeExtension(2,0);else if(214===t)e=this.decodeExtension(4,0);else if(215===t)e=this.decodeExtension(8,0);else if(216===t)e=this.decodeExtension(16,0);else if(199===t){const t=this.lookU8();e=this.decodeExtension(t,1)}else if(200===t){const t=this.lookU16();e=this.decodeExtension(t,2)}else{if(201!==t)throw new y(`Unrecognized type byte: ${x(t)}`);{const t=this.lookU32();e=this.decodeExtension(t,4)}}this.complete();const r=this.stack;for(;r.length>0;){const t=r.top();if(t.type===S){if(t.array[t.position]=e,t.position++,t.position!==t.size)continue t;e=t.array,r.release(t)}else{if(t.type===U){if("__proto__"===e)throw new y("The key __proto__ is not allowed");t.key=this.mapKeyConverter(e),t.type=E;continue t}if(t.map[t.key]=e,t.readCount++,t.readCount!==t.size){t.key=null,t.type=U;continue t}e=t.map,r.release(t)}}return e}}readHeadByte(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=-1}readArraySize(){const t=this.readHeadByte();switch(t){case 220:return this.readU16();case 221:return this.readU32();default:if(t<160)return t-144;throw new y(`Unrecognized array type byte: ${x(t)}`)}}pushMapState(t){if(t>this.maxMapLength)throw new y(`Max length exceeded: map length (${t}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(t)}pushArrayState(t){if(t>this.maxArrayLength)throw new y(`Max length exceeded: array length (${t}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(t)}decodeString(t,e){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(t,e):this.decodeBinary(t,e)}decodeUtf8String(t,e){if(t>this.maxStrLength)throw new y(`Max length exceeded: UTF-8 byte length (${t}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+e+t)throw B;const r=this.pos+e;let n;return n=this.stateIsMapKey()&&this.keyDecoder?.canBeCached(t)?this.keyDecoder.decode(this.bytes,r,t):l(this.bytes,r,t),this.pos+=e+t,n}stateIsMapKey(){if(this.stack.length>0){return this.stack.top().type===U}return!1}decodeBinary(t,e){if(t>this.maxBinLength)throw new y(`Max length exceeded: bin length (${t}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(t+e))throw B;const r=this.pos+e,n=this.bytes.subarray(r,r+t);return this.pos+=e+t,n}decodeExtension(t,e){if(t>this.maxExtLength)throw new y(`Max length exceeded: ext length (${t}) > maxExtLength (${this.maxExtLength})`);const r=this.view.getInt8(this.pos+e),n=this.decodeBinary(t,e+1);return this.extensionCodec.decode(n,r,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){const t=this.view.getUint8(this.pos);return this.pos++,t}readI8(){const t=this.view.getInt8(this.pos);return this.pos++,t}readU16(){const t=this.view.getUint16(this.pos);return this.pos+=2,t}readI16(){const t=this.view.getInt16(this.pos);return this.pos+=2,t}readU32(){const t=this.view.getUint32(this.pos);return this.pos+=4,t}readI32(){const t=this.view.getInt32(this.pos);return this.pos+=4,t}readU64(){const t=(e=this.view,r=this.pos,4294967296*e.getUint32(r)+e.getUint32(r+4));var e,r;return this.pos+=8,t}readI64(){const t=v(this.view,this.pos);return this.pos+=8,t}readU64AsBigInt(){const t=this.view.getBigUint64(this.pos);return this.pos+=8,t}readI64AsBigInt(){const t=this.view.getBigInt64(this.pos);return this.pos+=8,t}readF32(){const t=this.view.getFloat32(this.pos);return this.pos+=4,t}readF64(){const t=this.view.getFloat64(this.pos);return this.pos+=8,t}}function T(){T=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,i=Object.defineProperty||function(t,e,r){t[e]=r.value},o="function"==typeof Symbol?Symbol:{},s=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function h(t,e,r,n){var o=e&&e.prototype instanceof v?e:v,s=Object.create(o.prototype),a=new B(n||[]);return i(s,"_invoke",{value:I(t,r,a)}),s}function f(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=h;var l="suspendedStart",d="suspendedYield",y="executing",p="completed",g={};function v(){}function m(){}function w(){}var b={};u(b,s,(function(){return this}));var k=Object.getPrototypeOf,x=k&&k(k(P([])));x&&x!==r&&n.call(x,s)&&(b=x);var S=w.prototype=v.prototype=Object.create(b);function U(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function E(t,e){function r(i,o,s,a){var c=f(t[i],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==_(h)&&n.call(h,"__await")?e.resolve(h.__await).then((function(t){r("next",t,s,a)}),(function(t){r("throw",t,s,a)})):e.resolve(h).then((function(t){u.value=t,s(u)}),(function(t){return r("throw",t,s,a)}))}a(c.arg)}var o;i(this,"_invoke",{value:function(t,n){function i(){return new e((function(e,i){r(t,n,e,i)}))}return o=o?o.then(i,i):i()}})}function I(e,r,n){var i=l;return function(o,s){if(i===y)throw Error("Generator is already running");if(i===p){if("throw"===o)throw s;return{value:t,done:!0}}for(n.method=o,n.arg=s;;){var a=n.delegate;if(a){var c=A(a,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(i===l)throw i=p,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=y;var u=f(e,r,n);if("normal"===u.type){if(i=n.done?p:d,u.arg===g)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(i=p,n.method="throw",n.arg=u.arg)}}}function A(e,r){var n=r.method,i=e.iterator[n];if(i===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,A(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var o=f(i,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,g;var s=o.arg;return s?s.done?(r[e.resultName]=s.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,g):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function O(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function B(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[s];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function r(){for(;++i<e.length;)if(n.call(e,i))return r.value=e[i],r.done=!1,r;return r.value=t,r.done=!0,r};return o.next=o}}throw new TypeError(_(e)+" is not iterable")}return m.prototype=w,i(S,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:m,configurable:!0}),m.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===m||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(S),t},e.awrap=function(t){return{__await:t}},U(E.prototype),u(E.prototype,a,(function(){return this})),e.AsyncIterator=E,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new E(h(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},U(S),u(S,c,"Generator"),u(S,s,(function(){return this})),u(S,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,B.prototype={constructor:B,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(O),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(n,i){return a.type="throw",a.arg=e,r.next=n,i&&(r.method="next",r.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var s=this.tryEntries[o],a=s.completion;if("root"===s.tryLoc)return i("end");if(s.tryLoc<=this.prev){var c=n.call(s,"catchLoc"),u=n.call(s,"finallyLoc");if(c&&u){if(this.prev<s.catchLoc)return i(s.catchLoc,!0);if(this.prev<s.finallyLoc)return i(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return i(s.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return i(s.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=t,s.arg=e,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),O(r),g}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;O(r)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),g}},e}function _(t){return _="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_(t)}function C(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,M(n.key),n)}}function M(t){var e=function(t,e){if("object"!=_(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=_(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==_(e)?e:e+""}function F(t,e,r,n,i,o,s){try{var a=t[o](s),c=a.value}catch(t){return void r(t)}a.done?e(c):Promise.resolve(c).then(n,i)}function D(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function s(t){F(o,n,i,s,a,"next",t)}function a(t){F(o,n,i,s,a,"throw",t)}s(void 0)}))}}function z(t){switch(t){case"Number":return"int";case"Boolean":return"bool";case"String":return"str";case"Array":return"list";case"Object":return"dict";case"ArrayBuffer":case"Blob":return"bytes";case"t":return"ndarray";default:return t}}function N(t){return new Promise((function(e,r){var n=new FileReader;n.onload=function(){e(new Uint8Array(n.result)),n.close()},n.onerror=function(){r(n.error),n.close()},n.readAsArrayBuffer(t)}))}function W(t){return R.apply(this,arguments)}function R(){return R=D(T().mark((function t(e){var r,n=arguments;return T().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=3,N(e);case 3:return r=t.sent,t.abrupt("return",{type:"bytes",data:r,dtype:e.type});case 5:case"end":return t.stop()}}),t)}))),R.apply(this,arguments)}function $(t){return new Promise((function(e,r){var n=document.createElement("canvas"),i=n.getContext("2d"),o=function(t){var e=t.src;if(e)return e.startsWith("data")?e.split(";")[0].split(":")[1]:e.endsWith(".png")?"image/png":e.endsWith(".jpg")||e.endsWith(".jpeg")?"image/jpeg":e.endsWith(".gif")?"image/gif":e.endsWith(".bmp")?"image/bmp":"image/png"}(t);n.width=datum.width,n.height=datum.height,i.drawImage(datum,0,0),n.toBlob((function(t){W(t,o).then(e).catch(r)}),o)}))}var H=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}return e=t,r=null,n=[{key:"pack",value:(c=D(T().mark((function e(r){var n,i,o,s,c,u,h;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=r){e.next=4;break}return e.abrupt("return",{type:"null"});case 4:if(!(r instanceof ArrayBuffer)){e.next=8;break}return e.abrupt("return",{type:"bytes",data:new Uint8Array(r)});case 8:if(!(r instanceof Blob)){e.next=14;break}return e.next=11,W(r);case 11:case 25:return e.abrupt("return",e.sent);case 14:if(!(r instanceof a)){e.next=18;break}return e.abrupt("return",r.packed);case 18:if(!a.isTypedArray(r)){e.next=22;break}return e.abrupt("return",new a(r).packed);case 22:if(!("undefined"!=typeof Image&&r instanceof Image)){e.next=28;break}return e.next=25,$(r);case 28:if("function"!=typeof r){e.next=32;break}return e.abrupt("return",{type:"type",dtype:z(r.name)});case 32:if("number"!=typeof r){e.next=36;break}return e.abrupt("return",{type:r%1==0?"int":"float",data:r});case 36:if("boolean"!=typeof r){e.next=40;break}return e.abrupt("return",{type:"bool",data:r});case 40:if("string"!=typeof r){e.next=45;break}return n=new TextEncoder("utf-8"),e.abrupt("return",{type:"str",data:n.encode(r)});case 45:if(!Array.isArray(r)){e.next=52;break}return e.next=48,Promise.all(r.map(t.pack));case 48:return e.t0=e.sent,e.abrupt("return",{type:"list",items:e.t0});case 52:if("object"!==_(r)){e.next=64;break}for(s in i=Object.keys(r),o=[],r)o.push(t.pack(r[s]));return e.next=58,Promise.all(o);case 58:for(c=e.sent,u={},h=0;h<i.length;h++)u[i[h]]=c[h];return e.abrupt("return",{type:"dict",props:u});case 64:throw new Error("Unsupported datum type: ${typeof datum} (${datum.constructor.name})");case 65:case"end":return e.stop()}}),e)}))),function(t){return c.apply(this,arguments)})},{key:"unpack",value:(s=D(T().mark((function e(r){return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){switch(r.type){case"null":return e(null);case"int":case"float":case"bool":return e(r.data);case"bytes":return e(r.data.buffer);case"str":var i=new TextDecoder("utf-8");return e(i.decode(r.data));case"list":return Promise.all(r.items.map(t.unpack)).then(e).catch(n);case"dict":var o=[],s=[];for(var c in r.props)o.push(c),s.push(t.unpack(r.props[c]));return Promise.all(s).then((function(t){for(var r={},n=0;n<o.length;n++)r[o[n]]=t[n];e(r)})).catch(n);case"ndarray":case"tensor":return e(new a(r.data,r.shape,r.dtype));case"image":if("undefined"==typeof Image)return n(new Error("Image is not supported in this environment."));var u=new Blob([r.data],{type:"image/".concat(r.dtype)}),h=URL.createObjectURL(u),f=new Image;return f.addEventListener("load",(function(){e(f)})),f.src=h,f;case"audio":var l=new Blob([r.data],{type:"audio/".concat(r.dtype)}),d=URL.createObjectURL(l),y=new Audio;return y.addEventListener("loadeddata",(function(){e(y)})),y.src=d,y;case"exception":var p=new TextDecoder("utf-8").decode(r.data);return e(new Error("".concat(r.dtype,": ").concat(p)));default:console.error("Unhandled response type",r),n(new Error("Unsupported packed type: ".concat(r.type)))}})));case 1:case"end":return e.stop()}}),e)}))),function(t){return s.apply(this,arguments)})},{key:"encode",value:(o=D(T().mark((function e(r){var n;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.pack(r);case 2:return n=e.sent,e.abrupt("return",(i=n,new k(void 0).encodeSharedRef(i)));case 4:case"end":return e.stop()}var i}),e)}))),function(t){return o.apply(this,arguments)})},{key:"decode",value:(i=D(T().mark((function e(r){var n;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r,n=new j(void 0).decode(i),e.next=3,t.unpack(n);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}var i}),e)}))),function(t){return i.apply(this,arguments)})}],r&&C(e.prototype,r),n&&C(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,r,n,i,o,s,c}();function G(t){return G="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},G(t)}function K(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,V(n.key),n)}}function V(t){var e=function(t,e){if("object"!=G(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=G(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==G(e)?e:e+""}var q=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.holder=Promise.resolve()},(e=[{key:"acquire",value:function(){var t,e=new Promise((function(e){t=function(){return e()}})),r=this.holder.then((function(){return t}));return this.holder=e,r}}])&&K(t.prototype,e),r&&K(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,r}();function J(t){return J="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},J(t)}var Y=function(t){return null==t||""===t||"null"===t||Array.isArray(t)&&0===t.length||"object"===J(t)&&"Object"===t.constructor.name&&0===Object.getOwnPropertyNames(t).length},Q=function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(t){return(+t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>+t/4).toString(16)}))},X=function(t){var e=t.reduce((function(t,e){return t+e.length}),0),r=new t[0].constructor(e),n=0;return t.forEach((function(t){r.set(t,n),n+=t.length})),r};function Z(t){return Z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Z(t)}function tt(t,e,r){return e=it(e),function(t,e){if(e&&("object"==Z(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,et()?Reflect.construct(e,r||[],it(t).constructor):e.apply(t,r))}function et(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(et=function(){return!!t})()}function rt(t,e,r,n){var i=nt(it(1&n?t.prototype:t),e,r);return 2&n&&"function"==typeof i?function(t){return i.apply(r,t)}:i}function nt(){return nt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var n=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=it(t)););return t}(t,e);if(n){var i=Object.getOwnPropertyDescriptor(n,e);return i.get?i.get.call(arguments.length<3?t:r):i.value}},nt.apply(null,arguments)}function it(t){return it=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},it(t)}function ot(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&st(t,e)}function st(t,e){return st=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},st(t,e)}function at(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=ut(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){a=!0,o=t},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function ct(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,i,o,s,a=[],c=!0,u=!1;try{if(o=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=o.call(r)).done)&&(a.push(n.value),a.length!==e);c=!0);}catch(t){u=!0,i=t}finally{try{if(!c&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(u)throw i}}return a}}(t,e)||ut(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ut(t,e){if(t){if("string"==typeof t)return ht(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ht(t,e):void 0}}function ht(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function ft(t,e,r,n,i,o,s){try{var a=t[o](s),c=a.value}catch(t){return void r(t)}a.done?e(c):Promise.resolve(c).then(n,i)}function lt(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function s(t){ft(o,n,i,s,a,"next",t)}function a(t){ft(o,n,i,s,a,"throw",t)}s(void 0)}))}}function dt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function yt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,gt(n.key),n)}}function pt(t,e,r){return e&&yt(t.prototype,e),r&&yt(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function gt(t){var e=function(t,e){if("object"!=Z(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=Z(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Z(e)?e:e+""}function vt(){vt=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,i=Object.defineProperty||function(t,e,r){t[e]=r.value},o="function"==typeof Symbol?Symbol:{},s=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function h(t,e,r,n){var o=e&&e.prototype instanceof v?e:v,s=Object.create(o.prototype),a=new B(n||[]);return i(s,"_invoke",{value:I(t,r,a)}),s}function f(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=h;var l="suspendedStart",d="suspendedYield",y="executing",p="completed",g={};function v(){}function m(){}function w(){}var b={};u(b,s,(function(){return this}));var k=Object.getPrototypeOf,x=k&&k(k(P([])));x&&x!==r&&n.call(x,s)&&(b=x);var S=w.prototype=v.prototype=Object.create(b);function U(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function E(t,e){function r(i,o,s,a){var c=f(t[i],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==Z(h)&&n.call(h,"__await")?e.resolve(h.__await).then((function(t){r("next",t,s,a)}),(function(t){r("throw",t,s,a)})):e.resolve(h).then((function(t){u.value=t,s(u)}),(function(t){return r("throw",t,s,a)}))}a(c.arg)}var o;i(this,"_invoke",{value:function(t,n){function i(){return new e((function(e,i){r(t,n,e,i)}))}return o=o?o.then(i,i):i()}})}function I(e,r,n){var i=l;return function(o,s){if(i===y)throw Error("Generator is already running");if(i===p){if("throw"===o)throw s;return{value:t,done:!0}}for(n.method=o,n.arg=s;;){var a=n.delegate;if(a){var c=A(a,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(i===l)throw i=p,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=y;var u=f(e,r,n);if("normal"===u.type){if(i=n.done?p:d,u.arg===g)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(i=p,n.method="throw",n.arg=u.arg)}}}function A(e,r){var n=r.method,i=e.iterator[n];if(i===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,A(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var o=f(i,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,g;var s=o.arg;return s?s.done?(r[e.resultName]=s.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,g):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function O(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function B(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[s];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function r(){for(;++i<e.length;)if(n.call(e,i))return r.value=e[i],r.done=!1,r;return r.value=t,r.done=!0,r};return o.next=o}}throw new TypeError(Z(e)+" is not iterable")}return m.prototype=w,i(S,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:m,configurable:!0}),m.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===m||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(S),t},e.awrap=function(t){return{__await:t}},U(E.prototype),u(E.prototype,a,(function(){return this})),e.AsyncIterator=E,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new E(h(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},U(S),u(S,c,"Generator"),u(S,s,(function(){return this})),u(S,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,B.prototype={constructor:B,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(O),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(n,i){return a.type="throw",a.arg=e,r.next=n,i&&(r.method="next",r.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var s=this.tryEntries[o],a=s.completion;if("root"===s.tryLoc)return i("end");if(s.tryLoc<=this.prev){var c=n.call(s,"catchLoc"),u=n.call(s,"finallyLoc");if(c&&u){if(this.prev<s.catchLoc)return i(s.catchLoc,!0);if(this.prev<s.finallyLoc)return i(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return i(s.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return i(s.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=t,s.arg=e,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),O(r),g}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;O(r)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),g}},e}var mt=vt().mark(wt);function wt(t,e){var r;return vt().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=0;case 1:if(!(r<t.length)){n.next=7;break}return n.next=4,t.slice(r,r+e);case 4:r+=e,n.next=1;break;case 7:case"end":return n.stop()}}),mt)}var bt=function(){return pt((function t(e){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];dt(this,t),this.socket=null,this.address=e,this.lock=new q,this.debug=r,this.messageLength=null,this.messageBuffer=[],this.messageListeners=[],this.errorListeners=[]}),[{key:"isWebsocket",get:function(){return this.address.startsWith("ws://")||this.address.startsWith("wss://")}},{key:"isSecure",get:function(){return this.address.startsWith("wss://")||this.address.startsWith("https://")||!this.hasProtocol&&void 0!==window&&"https:"===window.location.protocol}},{key:"hasProtocol",get:function(){return this.addressHasProtocol(this.address)}},{key:"host",get:function(){return this.hasProtocol?new URL(this.address).host:void 0!==window&&void 0!==window.location?window.location.host:null}},{key:"address",get:function(){return this.url},set:function(t){this.url=t,this.socket&&this.socket.url===t||this.close()}},{key:"addressHasProtocol",value:function(t){return/^[a-z]+:\/\//.test(t)}},{key:"getWebsocket",value:function(){var t=this;return new Promise((function(e,r){t.lock.acquire().then((function(n){try{if(null!==t.socket&&void 0!==t.socket){if(t.socket.readyState===WebSocket.OPEN)return void e(t.socket);t.socket.readyState!==WebSocket.CONNECTING&&t.close()}if(null!==t.socket&&void 0!==t.socket)throw new Error("WebSocket connection is in state ".concat(t.socket.readyState,"."));t.socket=new WebSocket(t.address),t.socket.binaryType="arraybuffer",t.socket.addEventListener("open",(function(){e(t.socket)})),t.socket.addEventListener("message",function(){var e=lt(vt().mark((function e(r){return vt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.pushMessageChunk(r.data);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.socket.addEventListener("error",(function(e){t.dispatchError(e)}))}catch(e){if(console.error("Error getting WebSocket connection:",e),null!==t.socket&&void 0!==t.socket){try{t.socket.close()}catch(t){}delete t.socket}t.dispatchError(e),r(e)}finally{n()}}))}))}},{key:"close",value:function(){var t=this;this.socket&&this.socket.readyState===WebSocket.OPEN&&this.lock.acquire().then((function(e){t.socket.close(),delete t.socket,e()}))}},{key:"pushMessageChunk",value:(t=lt(vt().mark((function t(e){var r;return vt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===this.messageLength&&e.byteLength>=4&&(this.messageLength=new DataView(e).getUint32(0),e=e.slice(4)),this.messageBuffer.push(new Uint8Array(e)),r=this.messageBuffer.reduce((function(t,e){return t+e.byteLength}),0),!(null!==this.messageLength&&r>=this.messageLength)){t.next=19;break}if(1!==this.messageBuffer.length){t.next=12;break}return t.t0=this,t.next=8,H.decode(this.messageBuffer[0]);case 8:t.t1=t.sent,t.t0.dispatchMessage.call(t.t0,t.t1),t.next=17;break;case 12:return t.t2=this,t.next=15,H.decode(X(this.messageBuffer));case 15:t.t3=t.sent,t.t2.dispatchMessage.call(t.t2,t.t3);case 17:this.messageLength=null,this.messageBuffer=[];case 19:case"end":return t.stop()}}),t,this)}))),function(e){return t.apply(this,arguments)})},{key:"onMessage",value:function(t){this.messageListeners.push(t)}},{key:"onError",value:function(t){this.errorListeners.push(t)}},{key:"offMessage",value:function(t){this.messageListeners=this.messageListeners.filter((function(e){return e!==t}))}},{key:"offError",value:function(t){this.errorListeners=this.errorListeners.filter((function(e){return e!==t}))}},{key:"dispatchMessage",value:function(t){this.debug&&console.log("Received message:",t),this.messageListeners.forEach((function(e){return e(t)}))}},{key:"dispatchError",value:function(t){this.debug&&console.error("Received error:",t),this.errorListeners.forEach((function(e){return e(t)}))}},{key:"send",value:function(t){var e=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.debug&&console.log("Sending message:",t,"to",this.address),new Promise(function(){var n=lt(vt().mark((function n(i,o){var s,a,c,u,h,f,l,d,y,p,g,v,m,w,b,k;return vt().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,!e.isWebsocket){n.next=37;break}return n.next=4,Promise.all([e.getWebsocket(),H.encode(t)]);case 4:s=n.sent,a=ct(s,2),c=a[0],u=a[1],r&&(h=function(t){i(t),e.offMessage(h)},f=function(t){o(t),e.offError(f)},e.onMessage(h),e.onError(f)),l=new Uint8Array(new ArrayBuffer(4)),d=!1,new DataView(l.buffer).setUint32(0,u.length),y=at(wt(u,1048576)),n.prev=12,y.s();case 14:if((p=y.n()).done){n.next=26;break}if(g=p.value,d){n.next=22;break}return n.next=19,c.send(X([l,g]));case 19:d=!0,n.next=24;break;case 22:return n.next=24,c.send(g);case 24:n.next=14;break;case 26:n.next=31;break;case 28:n.prev=28,n.t0=n.catch(12),y.e(n.t0);case 31:return n.prev=31,y.f(),n.finish(31);case 34:r||i(),n.next=57;break;case 37:return n.next=39,H.encode(t);case 39:return v=n.sent,n.next=42,fetch(e.address,{method:"POST",body:v,headers:{"Content-Type":"application/octet-stream"}});case 42:if(!(m=n.sent).ok){n.next=54;break}return n.next=46,m.arrayBuffer();case 46:return w=n.sent,n.next=49,H.decode(new Uint8Array(w));case 49:b=n.sent,e.dispatchMessage(b),i(b),n.next=57;break;case 54:k=new Error("Error sending message: ".concat(m.statusText)),e.dispatchError(k),o(k);case 57:n.next=62;break;case 59:n.prev=59,n.t1=n.catch(0),o(n.t1);case 62:case"end":return n.stop()}}),n,null,[[0,59],[12,28,31,34]])})));return function(t,e){return n.apply(this,arguments)}}())}}]);var t}(),kt=function(t){function e(){return dt(this,e),tt(this,e,arguments)}return ot(e,t),pt(e,[{key:"send",value:function(t){var r,n=this,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("string"==typeof t)return rt(e,"send",this,3)([t,i]);if(!t instanceof Object)throw new Error("Message must be an object.");if(void 0!==t.request&&null!==t.request&&void 0!==t.request.id)r=t.request.id;else{if(void 0===t.id)throw new Error("Message must have an ID.");r=t.id}return i?new Promise((function(i,o){var s=function(t){t instanceof Error?o(t):t.id===r&&(i(t),n.offMessage(s))},a=function(t){o(t),n.offError(a),n.offMessage(s)};n.onMessage(s),n.onError(a),rt(e,"send",n,3)([t,!1])})):rt(e,"send",this,3)([t,!1])}}])}(bt);function xt(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return St(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?St(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){a=!0,o=t},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function St(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function Ut(t){return Ut="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ut(t)}function Et(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function It(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Lt(n.key),n)}}function At(t,e,r){return e&&It(t.prototype,e),r&&It(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function Lt(t){var e=function(t,e){if("object"!=Ut(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=Ut(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Ut(e)?e:e+""}var Ot=function(){return At((function t(e){Et(this,t),this.driver=e,this.scopes={}}),[{key:"getScope",value:function(t,e){return this.scopes.hasOwnProperty(t)||(this.scopes[t]=new Bt(t,this.driver,e)),this.scopes[t]}},{key:"getAll",value:function(){return Object.getOwnPropertyNames(this.scopes).reduce((function(t,e){return t[e]=storage.getScope(e).getAll(),t}),{})}},{key:"clear",value:function(){for(var t in this.scopes)this.getScope(t).clear()}}])}(),Bt=function(){return At((function t(e,r,n){Et(this,t),this.scope=e,this.driver=r,this.ttl=n,void 0===this.ttl&&(this.ttl=36e5)}),[{key:"getAll",value:function(){return this.keys().reduce((function(t,e){return t[e]=storage.getItem(e),t}),{})}},{key:"setItem",value:function(t,e){var r="".concat(this.scope,"-").concat(t),n="".concat(this.scope,"-").concat(t,"-expiration");this.driver.setItem(r,JSON.stringify(e)),this.driver.setItem(n,(new Date).getTime()+this.ttl)}},{key:"getItem",value:function(t){var e="".concat(this.scope,"-").concat(t),r="".concat(this.scope,"-").concat(t,"-expiration"),n=this.driver.getItem(e),i=this.driver.getItem(r);if(void 0!==n&&"undefined"!==n)return null===n||"null"===n?null:(n=JSON.parse(n),!Y(i)&&i<=(new Date).getTime()?(this.removeItem(e),null):n)}},{key:"keys",value:function(){var t="".concat(this.scope,"-");return(void 0!==this.driver.keys?this.driver.keys():Object.getOwnPropertyNames(this.driver)).filter((function(e){return e.startsWith(t)})).map((function(e){return e.substring(t.length)})).filter((function(t){return"expiration"!=t}))}},{key:"removeItem",value:function(t){var e="".concat(this.scope,"-").concat(t);return this.driver.removeItem(e)}},{key:"removePrefix",value:function(t){var e,r=xt(this.keys());try{for(r.s();!(e=r.n()).done;){var n=e.value;n.startsWith(t)&&this.removeItem(n)}}catch(t){r.e(t)}finally{r.f()}}},{key:"clear",value:function(){var t,e=xt(this.keys());try{for(e.s();!(t=e.n()).done;){var r=t.value;this.removeItem(r)}}catch(t){e.e(t)}finally{e.f()}return this.setItem("expiration",{}),this.driver.clear()}},{key:"key",value:function(t){return this.keys()[t]}}])}(),Pt=function(){return At((function t(){Et(this,t),this.expiration=new Date,this.expiration.setTime(this.expiration.getTime()+2592e6)}),[{key:"keys",value:function(){var t,e,r=[],n=xt(decodeURIComponent(document.cookie).split(";"));try{for(n.s();!(e=n.n()).done;){for(t=e.value.split("=")[0];" "==t.charAt(0);)t=t.substring(1);r.push(t)}}catch(t){n.e(t)}finally{n.f()}return r}},{key:"getItem",value:function(t){var e,r=xt(decodeURIComponent(document.cookie).split(";"));try{for(r.s();!(e=r.n()).done;){for(var n=e.value;" "==n.charAt(0);)n=n.substring(1);if(n.startsWith("".concat(t,"=")))return JSON.parse(n.substring(t.length+1))}}catch(t){r.e(t)}finally{r.f()}return null}},{key:"setItem",value:function(t,e,r){void 0===r&&(r=this.expiration),document.cookie=["".concat(t,"=").concat(JSON.stringify(e)),"expires=".concat(r.toUTCString()),"path=/",""].join(";")}},{key:"removeItem",value:function(t){var e=new Date;e.setTime(0),this.setItem(t,"",e)}},{key:"clear",value:function(){var t,e=xt(this.keys());try{for(e.s();!(t=e.n()).done;){var r=t.value;this.removeItem(r)}}catch(t){e.e(t)}finally{e.f()}}},{key:"key",value:function(t){return this.keys()[t]}}])}(),jt=function(){return At((function t(){Et(this,t),this.storage={}}),[{key:"keys",value:function(){return Object.getOwnPropertyNames(this.storage)}},{key:"setItem",value:function(t,e){this.storage[t]=e}},{key:"getItem",value:function(t){return this.storage.hasOwnProperty(t)?this.storage[t]:null}},{key:"removeItem",value:function(t){delete this.storage[t]}},{key:"removePrefix",value:function(t){var e,r=xt(this.keys());try{for(r.s();!(e=r.n()).done;){var n=e.value;n.startsWith(t)&&this.removeItem(n)}}catch(t){r.e(t)}finally{r.f()}}},{key:"clear",value:function(){var t,e=xt(this.keys);try{for(e.s();!(t=e.n()).done;){var r=t.value;delete this.storage[r]}}catch(t){e.e(t)}finally{e.f()}}},{key:"key",value:function(t){return this.keys()[t]}}])}();function Tt(t){return Tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Tt(t)}function _t(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return Ct(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ct(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){a=!0,o=t},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function Ct(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function Mt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Ft(n.key),n)}}function Ft(t){var e=function(t,e){if("object"!=Tt(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=Tt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Tt(e)?e:e+""}function Dt(t,e,r){return e=Wt(e),function(t,e){if(e&&("object"==Tt(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,zt()?Reflect.construct(e,r||[],Wt(t).constructor):e.apply(t,r))}function zt(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(zt=function(){return!!t})()}function Nt(){return Nt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var n=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=Wt(t)););return t}(t,e);if(n){var i=Object.getOwnPropertyDescriptor(n,e);return i.get?i.get.call(arguments.length<3?t:r):i.value}},Nt.apply(null,arguments)}function Wt(t){return Wt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Wt(t)}function Rt(t,e){return Rt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Rt(t,e)}var $t=new Ot(function(){try{return"undefined"!=typeof localStorage?localStorage:"undefined"!=typeof window?new Pt:new jt}catch(t){return console.error("Couldn't get local storage, defaulting to cookies.",t),new Pt}}()).getScope("taproot");function Ht(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null==t)return{type:"NoneType"};var e={parameter_type:t.constructor,parameter_size:1};if("undefined"!=typeof Blob&&t instanceof Blob)e.parameter_type="bytes",e.parameter_size=t.size;else if(t instanceof a)e.parameter_size=t.shape;else if(a.isTypedArray(t))t=new a(t),e.parameter_type=a,e.parameter_size=t.shape;else if("undefined"!=typeof Image&&t instanceof Image)e.parameter_size=[t.width,t.height];else if(Array.isArray(t))e.parameter_size=[t.length],e.parameter_sub_metadata=Ht(t[0]);else if(e.parameter_type===Object)for(var r in e.parameter_size=Object.keys(t).length,e.parameter_sub_metadata={},t)e.parameter_sub_metadata[r]=Ht(t[r]);else void 0!==t.length&&(e.parameter_size=t.length);return e}var Gt=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),Dt(this,e,arguments)}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Rt(t,e)}(e,t),r=e,n=[{key:"completeAddress",get:function(){if(this.hasProtocol)return this.address;if("undefined"!=typeof window&&void 0!==window.location){var t=window.location.href;if(this.isWebsocket&&(t=t.replace("http://","ws://").replace("https://","wss://")),!t.endsWith("/"))if(window.location.href===window.location.origin)t+="/";else{var e=t.lastIndexOf("/");t=t.substring(0,e+1)}return this.address.startsWith("/")?"".concat(t).concat(this.address.substring(1)):"".concat(t).concat(this.address)}return this.address}},{key:"clientId",get:function(){var t=$t.getItem("clientId");if(t)return t;var e=Q();return $t.setItem("clientId",e),e}},{key:"getClient",value:function(t){return null!==this.executors&&void 0!==this.executors||(this.executors={}),this.isWebsocket&&!this.addressHasProtocol(t)&&(t.startsWith("/")&&(t=t.substring(1)),t=null!==this.host?this.isSecure?"wss://".concat(this.host,"/").concat(t):"ws://".concat(this.host,"/").concat(t):this.isSecure?"wss://".concat(t):"ws://".concat(t)),null!==this.executors[t]&&void 0!==this.executors[t]||(this.debug&&console.log("Creating new client for ".concat(t)),this.executors[t]=new kt(t,this.debug)),this.executors[t]}},{key:"clearClientForTask",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null!==this.tasks&&void 0!==this.tasks||(this.tasks={}),null!==this.tasks[t]&&void 0!==this.tasks[t]||(this.tasks[t]={}),null==e&&(e="default"),null!==this.tasks[t][e]&&void 0!==this.tasks[t][e]&&this.tasks[t][e].close(),this.tasks[t][e]=null}},{key:"setClientForTask",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null!==this.tasks&&void 0!==this.tasks||(this.tasks={}),null!==this.tasks[e]&&void 0!==this.tasks[e]||(this.tasks[e]={}),null==r&&(r="default"),this.tasks[e][r]=t}},{key:"getClientForTask",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!==this.tasks&&void 0!==this.tasks||(this.tasks={}),null!==this.tasks[t]&&void 0!==this.tasks[t]||(this.tasks[t]={}),null==e&&(e="default"),null!==this.tasks[t][e]&&void 0!==this.tasks[t][e]?this.tasks[t][e]:null}},{key:"getLockForTask",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!==this.locks&&void 0!==this.locks||(this.locks={}),null!==this.locks[t]&&void 0!==this.locks[t]||(this.locks[t]={}),null==e&&(e="default"),null!==this.locks[t][e]&&void 0!==this.locks[t][e]||(this.locks[t][e]=new q),this.locks[t][e]}},{key:"sendInvocation",value:function(t,e){var r=this;e=e||{};var n=t.task,i=t.model||null,o=t.continuation,s=0,a=e.fetchIntermediates,c=e.pollingInterval||1e3,u=e.retryDelay||20,h=e.onIntermediateResult||function(t,e){return console.log("Ignored intermediate result",e,t)},f=e.onInterimResult||function(t,e){return console.log("Ignored interim result",e,t)};if(Y(n))throw new Error("Task is required.");return new Promise((function(l,d){t.id=Q(),t.client_id=r.clientId,t.overseer=r.completeAddress,t.return_metadata=!0,t.wait_for_result=!a;var y=r.getClientForTask(n,i),p=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return new Promise((function(n,i){var o=t.id,l=t.address,d=r.getClient(l),y=function(){return d.send({id:o,client_id:r.clientId,return_metadata:!0,wait_for_result:!a})},g=function(e){d.offError(g),d.offMessage(v),retry?p(t,!1).then(n).catch(i):(console.error("Error with continuation",o,"from",l,e),i(e))},v=function(r){if(r instanceof Error)d.offMessage(v),d.offError(g),e>0?setTimeout((function(){p(t,e-1).then(n).catch(i)}),u):(console.error("Error with continuation",o,"from",l,r),i(r));else if(r.id==o)if(["error","complete"].includes(r.status))if(d.offMessage(v),d.offError(g),"error"===r.status)i(r.result);else if(r.continuation){f(r.result,s),s++;var a=r.continuation,m=!1;Array.isArray(a)||(a=[a],m=!0);var w,b=[],k=_t(a);try{for(k.s();!(w=k.n()).done;){var x=w.value;b.push(p(x))}}catch(t){k.e(t)}finally{k.f()}Promise.all(b).then((function(t){n(m?t[0]:t)})).catch(i)}else n(r.result);else Y(r.intermediate)||h(r.intermediate,s),setTimeout(y,c)};d.onMessage(v),d.onError(g),y()}))},g=function(){return y.send({id:t.id,client_id:r.clientId,return_metadata:!0,wait_for_result:!a})},v=function(e){if(e.id===t.id)if(["error","complete"].includes(e.status))if(y.offMessage(v),y.offError(m),o)if(f(e.result,s),s++,e.continuation&&e.continuation.id){var r=e.continuation,n=!1;Array.isArray(r)||(r=[r],n=!0);var i,a=[],u=_t(r);try{for(u.s();!(i=u.n()).done;){var w=i.value;a.push(p(w))}}catch(t){u.e(t)}finally{u.f()}Promise.all(a).then((function(t){l(n?t[0]:t)})).catch(d)}else d("Continuation request but not found in message");else l(e.result);else Y(e.intermediate)||h(e.intermediate,s),setTimeout(g,c)},m=function(t){y.offMessage(v),y.offError(m),d(t)},w=t.parameters;if(null===y)t.parameters=function(t){var e={};for(var r in t)e[r]=Ht(t[r]);return e}(w),r.send(t).then((function(e){e.address?e.address.startsWith("tcp://")||e.address.startsWith("tcps://")||e.address.startsWith("unix://")?d("Executor is not configured for websocket or HTTP communication, received: ".concat(e.address)):(t.parameters=w,(y=r.getClient(e.address)).onMessage(v),y.onError(m),y.send(t,!1),r.setClientForTask(y,n,i)):d("No address found for executor.")})).catch(d);else{r.debug&&console.log("Reusing client for task",n);var b=function(o){y.offMessage(v),y.offError(b),r.clearClientForTask(n,i),r.sendInvocation(t,e).then((function(t){l(t)})).catch((function(t){d(t)}))};t.parameters=w,y.onMessage(v),y.onError(b),y.send(t,!1)}}))}},{key:"invoke",value:function(t,e){var r=this,n=t.task,i=t.model||null;if(Y(n))throw new Error("Task is required.");return new Promise((function(o,s){r.getLockForTask(n,i).acquire().then((function(n){return r.sendInvocation(t,e).then((function(t){n(),o(t)})).catch((function(t){n(),s(t)}))}))}))}},{key:"close",value:function(){for(var t in this.tasks)for(var r in this.tasks[t])this.clearClientForTask(t,r);var n,i,o,s,a;(n=e,i="close",o=this,a=Nt(Wt(1&(s=3)?n.prototype:n),i,o),2&s&&"function"==typeof a?function(t){return a.apply(o,t)}:a)([])}}],n&&Mt(r.prototype,n),i&&Mt(r,i),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,n,i}(kt);return"undefined"!=typeof window&&(window.Taproot=Gt),e})()));